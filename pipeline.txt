pipeline{
    agent any
    tools{
        jdk 'jdk17'
        nodejs 'node16'
    }
    environment {
        SCANNER_HOME=tool 'sonar-scanner'
        GROQ_API_KEY = credentials('groq')
        WORKSPACE_PATH = '/var/lib/jenkins/workspace/jenkins-pipeline'
    }
    stages {
        stage('clean workspace'){
            steps{
                cleanWs()
            }
        }
        stage('Checkout from Git'){
            steps{
                git branch: 'main', url: 'https://github.com/DaoAnhThien/kltn1'
            }
        }
        stage("Sonarqube Analysis "){
            steps{
                withSonarQubeEnv('sonar-scanner') {
                    sh ''' $SCANNER_HOME/bin/sonar-scanner -Dsonar.projectName=netflix \
                    -Dsonar.projectKey=netflix '''
                }
            }
        }
        stage('Install Dependencies') {
            steps {
                sh "npm install"
            }
        }
        stage('OWASP FS SCAN') {
            steps {
                dependencyCheck additionalArguments: '--scan ./ --disableYarnAudit --disableNodeAudit', odcInstallation: 'DP-Check'
                dependencyCheckPublisher pattern: '**/dependency-check-report.xml'
            }
        }
        stage('TRIVY FS SCAN') {
            steps {
                sh "trivy fs --format table -o trivy-fs-report.json ."
            }
        }
        stage("Docker Build & Push") {
            steps {
                script {
                    withDockerRegistry(credentialsId: 'docker-cred', toolName: 'docker') {
                        withCredentials([string(credentialsId: 'tmdb-api-key', variable: 'TMDB_API_KEY')]) {
                            sh "docker build --build-arg TMDB_V3_API_KEY=\${TMDB_API_KEY} -t netflix ."
                            sh "docker tag netflix p3rryhehe/kltn1:v1"
                            sh "docker push p3rryhehe/kltn1:v1"
                        }    
                    }
                }
            }
        }
        stage("TRIVY"){
            steps{
                sh "trivy image --format json -o trivy-image-report.json p3rryhehe/kltn1:v1"
                sh "cat trivy-image-report.json" 
            }
        }
        stage('LLM Analysis') {
            when {
                expression { fileExists('trivy-image-report.json') }
            }
            steps {
                sh '''
                # Khởi động Ollama 
                pgrep ollama > /dev/null || (ollama serve &) && sleep 3
    
                # Lấy vulnerabilities bằng jq 
                VULNS=$(jq -c '
                    [.Results[].Vulnerabilities[]? | 
                    {CVE: .VulnerabilityID, Pkg: .PkgName, Sev: .Severity, Desc: .Title}
                    ]' trivy-image-report.json)
    
                # Nếu không có lỗ hổng
                if [ -z "$VULNS" ] || [ "$VULNS" = "[]" ]; then
                    echo "# Không phát hiện lỗ hổng" > analysis_ollama.json
                    cat analysis_ollama.json
                    exit 0
                fi
    
                # prompt
                PROMPT="Bạn là chuyên gia bảo mật phần mềm. Phân tích và tóm tắt các lỗ hổng bảo mật từ dữ liệu JSON sau: $VULNS
                        Yêu cầu output chính xác theo cấu trúc sau (không thêm nội dung thừa, chỉ output theo định dạng này):
                        Bảng số lượng lỗ hổng theo mức độ nghiêm trọng:
                        - Sử dụng bảng Markdown với hai cột: 'Mức độ' và 'Số lượng'.
                        - Bao gồm các mức: CRITICAL, HIGH, MEDIUM, LOW, và UNKNOWN (nếu có lỗ hổng thuộc mức khác).
                        - Nếu không có lỗ hổng ở mức nào, ghi số lượng là 0.
                        Danh sách chi tiết tất cả lỗ hổng:
                        - Sử dụng bảng Markdown với bốn cột: 'CVE', 'Gói', 'Mức độ', 'Mô tả ngắn gọn'.
                        - Liệt kê toàn bộ, không bỏ sót bất kỳ lỗ hổng nào.
                        - Giữ mô tả ngắn gọn (dưới 50 từ mỗi mục), dịch hoặc giữ nguyên nếu cần thiết để dễ hiểu.
                        Toàn bộ output phải bằng tiếng Việt, sử dụng Markdown để định dạng rõ ràng, dễ đọc. Không thêm tiêu đề hoặc giải thích ngoài yêu cầu."
    
                # Gọi model
                ollama run llama3.2:3b "$PROMPT" > analysis_ollama.json
    
                # Hiển thị báo cáo 
                echo "BÁO CÁO"
                cat analysis_ollama.json
            '''
            }
            post {
                always {
                    archiveArtifacts artifacts: 'analysis_ollama.json', allowEmptyArchive: true
                }
            }
        }
        stage('Deploy to container'){
            steps{
                sh 'docker run -d -p 8077:80 p3rryhehe/kltn1:v1'
            }
        }
    }
    post {
     always {
        emailext attachLog: true,
            subject: "'${currentBuild.result}'",
            body: "Project: ${env.JOB_NAME}<br/>" +
                "Build Number: ${env.BUILD_NUMBER}<br/>" +
                "URL: ${env.BUILD_URL}<br/>",
            to: 'daoanhthienahihi@gmail.com',                               
            attachmentsPattern: 'trivy-fs-report.json,trivy-image-report.json'
        }
    }
}
