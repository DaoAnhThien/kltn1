pipeline {
    agent any
    tools {
        jdk 'jdk17'
        nodejs 'node16'
    }
    environment {
        SCANNER_HOME = tool 'sonar-scanner'
        GROQ_API_KEY = credentials('groq')
        WORKSPACE_PATH = '/var/lib/jenkins/workspace/netflix'
        DOJO_URL = 'http://127.0.0.1:8089'
        DOJO_PRODUCT_ID = '2'
        DOJO_PRODUCT_NAME = 'Netflix Clone App'
        ARGOCD_SERVER = "https://localhost:8001"
        ARGO_USER = "admin"
    }
    stages {
        stage('clean workspace') {
            steps {
                cleanWs()
            }
        }
        stage('Checkout from Git') {
            steps {
                git branch: 'main', url: 'https://github.com/DaoAnhThien/kltn1'
            }
        }
        stage("Sonarqube Analysis ") {
            steps {
                withSonarQubeEnv('sonar-scanner') {
                    sh ''' $SCANNER_HOME/bin/sonar-scanner -Dsonar.projectName=netflix \
                    -Dsonar.projectKey=netflix '''
                }
            }
        }
        stage('Install Dependencies') {
            steps {
                sh "npm install"
            }
        }
        stage('OWASP FS SCAN') {
            steps {
                dependencyCheck additionalArguments: '--scan ./ --disableYarnAudit --disableNodeAudit', odcInstallation: 'DP-Check'
                dependencyCheckPublisher pattern: '**/dependency-check-report.xml'
            }
        }
        stage('TRIVY FS SCAN') {
            steps {
                sh "trivy fs --format json -o trivy-fs-report.json ."
            }
        }
        stage("Docker Build, Sign & Push (Content Trust)") {
            steps {
                script {
                    withDockerRegistry(credentialsId: 'docker-cred', toolName: 'docker') {
                        withCredentials([
                            string(credentialsId: 'tmdb-api-key', variable: 'TMDB_API_KEY'),
                            string(credentialsId: 'dct-root-passphrase', variable: 'DCT_ROOT_PASSPHRASE'),
                            string(credentialsId: 'dct-repo-passphrase', variable: 'DCT_REPO_PASSPHRASE')
                        ]) {
                            sh '''
                                export DOCKER_BUILDKIT=1
                                export DOCKER_CONTENT_TRUST=1
                        
                                export DOCKER_CONTENT_TRUST_ROOT_PASSPHRASE="$DCT_ROOT_PASSPHRASE"
                                export DOCKER_CONTENT_TRUST_REPOSITORY_PASSPHRASE="$DCT_REPO_PASSPHRASE"
                        
                                docker build \
                                  --secret id=tmdb_api_key,env=TMDB_API_KEY \
                                  -t p3rryhehe/kltn1:v1 .
                        
                                docker push p3rryhehe/kltn1:v1
                            '''
                        }
                    }
                }
            }
        }
    

        stage("Verify Docker Image Signature") {
            steps {
                sh '''
                    export DOCKER_CONTENT_TRUST=1
                    docker trust inspect --pretty p3rryhehe/kltn1:v1
                '''
            }
        }

        stage("TRIVY") {
            steps {
                sh "trivy image --format json -o trivy-image-report.json p3rryhehe/kltn1:v1"
                sh "cat trivy-image-report.json"
            }
        }
        stage('LLM Analysis') {
            when {
                expression { fileExists('trivy-image-report.json') }
            }
            steps {
                sh '''
                    echo "Starting LLM analysis..."

                    # Chạy Ollama nếu chưa khởi động, giữ sống 60s để tránh chiếm RAM lâu
                    pgrep ollama > /dev/null || (OLLAMA_KEEPALIVE=60 nohup ollama serve > /dev/null 2>&1 &)
                    sleep 2

                    # Lấy vulnerabilities nhỏ gọn (chỉ 100 đầu tiên để tránh quá tải)
                    VULNS=$(jq -c '[.Results[].Vulnerabilities[]? | {CVE: .VulnerabilityID, Pkg: .PkgName, Sev: .Severity, Desc: .Title, Ref: .PrimaryURL}] | .[:100]' trivy-image-report.json)

                    if [ -z "$VULNS" ] || [ "$VULNS" = "[]" ]; then
                        echo "# Không phát hiện lỗ hổng" > analysis_ollama.json
                        cat analysis_ollama.json
                        exit 0
                    fi

                    # Prompt tinh gọn, hạn chế token
                    PROMPT="Bạn là chuyên gia bảo mật. Hãy tóm tắt và phân tích các lỗ hổng bảo mật sau đây (JSON):
                    $VULNS
                    Yêu cầu:
                    1. Bảng tóm tắt số lượng lỗ hổng theo mức độ (CRITICAL, HIGH, MEDIUM, LOW, UNKNOWN).
                    2. Bảng chi tiết với cột: CVE | Gói | Mức độ | Mô tả đầy đủ | URL.
                    Output phải bằng tiếng Việt, trình bày Markdown rõ ràng, không thêm nội dung ngoài yêu cầu."

                    # Giới hạn token để tránh hết RAM
                    ollama run llama3.2:1b "$PROMPT" > analysis_ollama.json
                '''
            }
            post {
                always {
                    archiveArtifacts artifacts: 'analysis_ollama.json', allowEmptyArchive: true
                }
            }
        }
        stage('Upload to DefectDojo') {
            steps {
                script {
                    withCredentials([
                        usernamePassword(credentialsId: 'dojo-admin', usernameVariable: 'DOJO_USER', passwordVariable: 'DOJO_PASS')
                    ]) {

                        // Upload Trivy scan
                        sh '''
                        TRIVY_IMAGE_JSON="${WORKSPACE_PATH}/trivy-image-report.json"
                        LLM_REPORT_JSON="${WORKSPACE_PATH}/analysis_ollama.json"
                        if [ ! -f "${TRIVY_IMAGE_JSON}" ]; then
                            echo "ERROR: File ${TRIVY_IMAGE_JSON} không tồn tại!"
                            exit 1
                        fi

                        echo "Uploading Trivy scan to DefectDojo..."
                        curl -k -X POST "${DOJO_URL}/api/v2/import-scan/" \
                            -u "$DOJO_USER:$DOJO_PASS" \
                            -F "scan_type=Trivy Scan" \
                            -F "product_id=${DOJO_PRODUCT_ID}" \
                            -F "engagement=3" \
                            -F "file=@${TRIVY_IMAGE_JSON}" \
                            -F "verified=True" \
                            -F "active=True"
                        '''

                        // Upload LLM analysis report
                        sh '''
                        TRIVY_IMAGE_JSON="${WORKSPACE_PATH}/trivy-image-report.json"
                        LLM_REPORT_JSON="${WORKSPACE_PATH}/analysis_ollama.json"
                        if [ ! -f "${LLM_REPORT_JSON}" ]; then
                            echo "ERROR: File ${LLM_REPORT_JSON} không tồn tại!"
                            exit 1
                        fi

                        echo "Uploading LLM analysis report to DefectDojo as Note."

                        if [ ! -f "analysis_ollama.json" ]; then
                            echo "File analysis_ollama.json không tồn tại!"
                            exit 1
                        fi

                        NOTE_CONTENT=$(jq -Rs . analysis_ollama.json)

                        # Tạo payload JSON tạm
                        cat <<EOF > note_payload.json
                        {
                            "entry": ${NOTE_CONTENT},
                            "note_type_id": 1
                        }
                        EOF

                        curl -k -X POST "${DOJO_URL}/api/v2/engagements/3/notes/" \
                            -u "$DOJO_USER:$DOJO_PASS" \
                            -H "Content-Type: application/json" \
                            -d @note_payload.json
                        '''
                    }
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'trivy-image-report.json, analysis_ollama.json', allowEmptyArchive: true
                }
            }
        }
        stage('ArgoCD start') {
            steps {
                script {
                    withCredentials([
                        usernamePassword(credentialsId: 'argocd', usernameVariable: 'ARGO_USER', passwordVariable: 'ARGO_PASS'),
                        file(credentialsId: 'minikube', variable: 'kubeconfig')
                    ]) {
        
                        withKubeConfig([credentialsId: 'minikube']) {
        
                            sh """
                                # Port-forward ArgoCD
                                kubectl port-forward svc/argocd-server -n argocd 8001:443 >/dev/null 2>&1 &
                                sleep 5
                            
                                # Login
                                TOKEN=\$(curl -sk -X POST https://localhost:8001/api/v1/session \\
                                  -H "Content-Type: application/json" \\
                                  -d "{\\"username\\":\\"$ARGO_USER\\",\\"password\\":\\"$ARGO_PASS\\"}" \\
                                  | jq -r .token)
                            
                                if [ -z "\$TOKEN" ] || [ "\$TOKEN" = "null" ]; then
                                    echo "Failed to get ArgoCD token"
                                    exit 1
                                fi
                            
                                echo "Token received: \$TOKEN"
                            
                                # Sync app
                                curl -sk -X POST https://localhost:8001/api/v1/applications/netflix/sync \\
                                  -H "Authorization: Bearer \$TOKEN" \\
                                  -H "Content-Type: application/json" \\
                                  -d '{ "prune": false, "dryRun": false }'
                            
                                echo "Sync request sent"
                            """
                        }
                    }
                }
            }
        }
    }
    post {
        always {
            emailext attachLog: true,
                subject: "'${currentBuild.result}'",
                body: "Project: ${env.JOB_NAME}<br/>" +
                    "Build Number: ${env.BUILD_NUMBER}<br/>" +
                    "URL: ${env.BUILD_URL}<br/>",
                to: 'daoanhthienahihi@gmail.com',
                attachmentsPattern: 'trivy-fs-report.json,trivy-image-report.json'
        }
    }
}
